<!DOCTYPE html>
<html lang="en" >
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="為了可能的聲音"> 
    <meta name="author" content="Rex Tsou">
    <meta name="copyright" content="Rex Tsou">
    
    <meta property="og:title" content="增加 SSH 登入安全性（二）">
    <meta property="og:type" content="article">
    <meta property="og:description" content="為了可能的聲音">
    
    <meta itemprop="name" content="增加 SSH 登入安全性（二） | 為了可能的聲音">
    <meta itemprop="description" content="為了可能的聲音">
    <title>增加 SSH 登入安全性（二） | 為了可能的聲音</title>
    <link rel="stylesheet" href="https://blog.rex-tsou.com/css/style.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 
  </head>

<header class="section header">
  <div class="container">
    <nav class="nav">
      <div class="nav__left">
        <a class="nav__item" href="https://blog.rex-tsou.com"><h1 class="title">為了可能的聲音</h1></a>
      </div>
      <div class="nav__right">
        <nav class="nav__item">
          <a class="item__link" href="/post">Archives</a>
        </nav>
        <nav class="nav__item">
          
          <a class="item__link" href="https://github.com/akccakcctw" target="_blank" rel="noopener">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="item__link" href="https://www.facebook.com/akccakcctw" target="_blank" rel="noopener">
            <span class="icon">
              <i class="fa fa-facebook-square"></i>
            </span>
          </a>
          
          <a class="item__link" href="/index.xml" target="_blank" rel="noopener">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</header>

<section class="section">
  <div class="container">
    <time class="date date--publish">June 23, 2019</time>
    
    <h1 class="title">增加 SSH 登入安全性（二）</h1>
    <div class="content">
      <p>延續<a href="https://blog.rex-tsou.com/2019/03/%E5%A2%9E%E5%8A%A0-ssh-%E7%99%BB%E5%85%A5%E5%AE%89%E5%85%A8%E6%80%A7/">上篇</a>，除了調整 sshd_config 設定以提高安全性外，還有個常用的工具 <a href="https://www.fail2ban.org">fail2ban</a>。</p>
<p>本文介紹的 fail2ban 是 v0.9.7，請注意不同版本的設定方式可能會稍有不同。</p>
<p>fail2ban 會分析你的 log 檔，藉由登入失敗記錄來防止暴力破解。</p>
<h2 id="heading">安裝</h2>
<p>我的 server 是 CentOS 7，因此使用 <code>yum</code> 安裝：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># 安裝前先看一下相關訊息</span>
yum info fail2ban

yum install fail2ban
</code></pre></div><h2 id="heading-1">設定</h2>
<p>裝好後，可依需求調整相關設定檔：</p>
<h3 id="fail2banconflocal">fail2ban.(conf|local)</h3>
<p>位置在 <code>/etc/fail2ban/fail2ban.conf</code>，檔案內的註解寫得很詳細，大部分情況不需要修改，需要修改時新增一支 fail2ban.local，會 override 預設的設定，就不多說明了。</p>
<h3 id="jailconflocal">jail.(conf|local)</h3>
<p>位置在 <code>/etc/fail2ban/jail.conf</code>，fail2ban 會依據這支檔案的設定來決定如何封鎖，和 fail2ban.conf 類似，要修改時新增一支 jail.local 來 override 預設值。</p>
<p>我的設定如下（新增一支 jail.local）：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># /etc/fail2ban/jail.local</span>
<span style="color:#f92672">[</span>sshd<span style="color:#f92672">]</span>
enabled  <span style="color:#f92672">=</span> true
port     <span style="color:#f92672">=</span> ssh
filter   <span style="color:#f92672">=</span> sshd
action   <span style="color:#f92672">=</span> iptables<span style="color:#f92672">[</span>name<span style="color:#f92672">=</span>SSH, port<span style="color:#f92672">=</span>ssh, protocol<span style="color:#f92672">=</span>tcp<span style="color:#f92672">]</span>
<span style="color:#75715e"># logpath  = /var/log/secure</span>
backend  <span style="color:#f92672">=</span> systemd
maxretry <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
findtime <span style="color:#f92672">=</span> <span style="color:#ae81ff">600</span> ; <span style="color:#ae81ff">10</span> minutes
bantime  <span style="color:#f92672">=</span> <span style="color:#ae81ff">1200</span> ; <span style="color:#ae81ff">20</span> minutes
</code></pre></div><p>注意註解起來的 logpath 那一行，因為我的 server 使用 systemd，因此我設定使用 <code>backend = systemd</code>，原因可以參考<a href="https://bbs.archlinux.org/viewtopic.php?id=190394">這裡</a>。</p>
<p>其餘各項設定代表的意思：</p>
<ul>
<li>ignoreip：白名單</li>
<li>action：要執行的動作</li>
<li>filter：使用的 filter（在 /etc/fail2ban/filter.d/ 底下）</li>
<li>maxretry：在 findtime 內最多可以嘗試的次數</li>
<li>findtime：多少時間內檢查 retry 次數（秒）</li>
<li>bantime：封鎖時間（秒）</li>
</ul>
<h3 id="filterd">filter.d/</h3>
<p>定義過濾條件，此目錄下已有多種內建的過濾條件，例如 apache、sshd、postfix 等等。</p>
<h3 id="actiond">action.d/</h3>
<p>定義動作內容，例如 sendmail（寄信通知）、iptables（阻擋來源 ip）等等。</p>
<p>我們上面使用 iptables 阻擋，但它預設使用 REJECT，可以改為 DROP。一樣新增 .local 檔來 override ：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># /etc/fail2ban/action.d/iptables-common.local</span>
<span style="color:#f92672">[</span>Init<span style="color:#f92672">]</span>
blocktype <span style="color:#f92672">=</span> DROP
</code></pre></div><h2 id="heading-2">啟動</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># 啟動服務</span>
systemctl start fail2ban.service <span style="color:#75715e"># 或 service fail2ban start</span>

<span style="color:#75715e"># 重新啟動服務（如果有修改設定）</span>
systemctl restart fail2ban.service

<span style="color:#75715e"># 設定開機啟動</span>
systemctl enable fail2ban.service <span style="color:#75715e"># 或 chkconfig fail2ban on</span>
</code></pre></div><h2 id="heading-3">測試</h2>
<p>啟動後，使用 <code>fail2ban-client ping</code>，會看到回應 <code>pong</code>，代表 fail2ban 有正常運作。</p>
<p>再來，使用 <code>fail2ban-client status</code> 應該會看到類似這樣的訊息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">╭─akccakcctw@rex-tsou ~
╰─$ sudo fail2ban-client status
Status
|- Number of jail:      <span style="color:#ae81ff">1</span>
<span style="color:#e6db74">`</span>- Jail list:   sshd
</code></pre></div><p>代表 sshd 這個服務已經受到 fail2ban 的保護。進一步看 sshd 的狀態，則使用指令 <code>fail2ban-client status sshd</code>，會有更詳細的訊息。</p>
<p>而 fail2ban 的 log 預設會記錄在 /var/log/fail2ban.log 這個路徑，可以從這個檔案看到目前 fail2ban 檢測到哪些可疑 ip。</p>
<p>如果想測試是否真的會被 ban，可以用 <code>tail -f /var/log/fail2ban.log</code>，或是 <code>journalctl -f -u sshd</code> 觀察 log 變化，再用另外一台電腦嘗試用錯誤密碼登入。</p>
<h2 id="-ip">查看／解禁被封鎖的 IP</h2>
<h3 id="heading-4">查看</h3>
<p>由於我們上面使用 iptables 封鎖，因此我們可以直接列出 iptables 資訊來查看被封鎖的 IP：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo iptables --list -n
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># 假設是 192.168.1.2 被 ban</span>
Chain f2b-SSH <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> references<span style="color:#f92672">)</span>
target     prot opt source               destination
REJECT     all  --  192.168.1.2          0.0.0.0/0            reject-with icmp-port-unreachable
RETURN     all  --  0.0.0.0/0            0.0.0.0/0
</code></pre></div><p>也可以使用 fail2ban-client 來查看被封鎖的 IP 位置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">sudo fail2ban-client status sshd
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">╭─akccakcctw@rex-tsou ~
╰─$ sudo fail2ban-client status sshd
Status <span style="color:#66d9ef">for</span> the jail: sshd
|- Filter
|  |- Currently failed: <span style="color:#ae81ff">0</span>
|  |- Total failed:     <span style="color:#ae81ff">5</span>
|  <span style="color:#e6db74">`</span>- Journal matches:  _SYSTEMD_UNIT<span style="color:#f92672">=</span>sshd.service + _COMM<span style="color:#f92672">=</span>sshd
<span style="color:#e6db74">`</span>- Actions
   |- Currently banned: <span style="color:#ae81ff">1</span>
   |- Total banned:     <span style="color:#ae81ff">2</span>
   <span style="color:#e6db74">`</span>- Banned IP list:   192.168.1.2
</code></pre></div><h3 id="heading-5">解鎖</h3>
<p>想要解鎖某個 IP 的話，可以使用 iptables 指令，也可以使用 fail2ban-client：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># iptables</span>
sudo iptables -D f2b-SSH -s 192.168.1.2 -j REJECT

<span style="color:#75715e"># fail2ban-client</span>
sudo fail2ban-client set sshd unbanip 192.168.1.2
</code></pre></div><h2 id="fail2ban-">fail2ban 相關指令</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># 查看 fail2ban 狀態</span>
fail2ban-client status

<span style="color:#75715e"># 查看特定服務狀態</span>
fail2ban-client status sshd

<span style="color:#75715e"># 以 filter 規則測試既有 log 檔</span>
<span style="color:#75715e"># syntax: fail2ban-regex [log file] [filter_rule file]</span>
fail2ban-regex /var/log/secure /etc/fail2ban/filter.d/sshd.conf
</code></pre></div><h2 id="heading-6">參考資料</h2>
<ul>
<li><a href="https://newtoypia.blogspot.com/2016/04/fail2ban.html">fail2ban： 新手老手 root 網管都要練的金鐘罩</a></li>
<li><a href="https://net.nthu.edu.tw/2009/security:fail2ban">清大網路系統組 Fail2ban 教學</a></li>
<li><a href="http://www.vixual.net/blog/archives/252">用 Fail2Ban 防範暴力破解（SSH、vsftp、dovecot、sendmail）</a></li>
<li><a href="http://xmodulo.com/how-to-protect-ssh-server-from-brute-force-attacks-using-fail2ban.html">How to protect SSH server from brute force attacks using fail2ban</a></li>
<li><a href="https://www.booleanworld.com/protecting-ssh-fail2ban/">Protecting SSH with Fail2ban</a></li>
</ul>

    </div>
    <blockquote class="page-info">
      最後更新時間：<time class="date date--update">June 25, 2019</time>
    </blockquote>
  </div>
</section>

<section class="section disqus">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'akccakcctw';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>



<footer class="section footer">
  <div class="container">
    <p>© 2018 <a href="https://github.com/akccakcctw" target="_blank">Rex Tsou</a></p>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/vim.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scss.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-57924156-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



